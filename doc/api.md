# Skyscraper: API documentation

## Namespace: `skyscraper`

### `defprocessor`

If the output doesn’t contain the new URL and processor, it is considered a terminal node and Skyscraper will include it as part of the output. If the processor returns one context only, it is automatically wrapped in a seq.

In addition, `defprocessor` supports several other clauses that determine the pages that it visits and how they are cached. These are:

 - `:url-fn` – a one-argument function taking the context and returning the URL to visit. By default, Skyscraper just extracts the value under the `:url` key from the context.
 - `:cache-template` – a string specifying the template for cache keys (see below). Ignored when `:cache-key-fn` is specified.
 - `:cache-key-fn` – a function taking the context and returning the cache key (see below). Overrides `:cache-template`. Useful when mere templating does not suffice.
 - `:error-handler` – an error handler (see below).
 - `:updatable` – a boolean (false by default). When true, the pages accessed by this processor are considered to change often. When Skyscraper is run in update mode (see below), these pages will be re-downloaded and re-processed even if they had been present in the HTML or processed caches, respectively.
 - `:parse-fn` – a custom function that will be used to produce Enlive resources from HTMLs. This is useful rather rarely, e.g., when you’re scraping malformed HTML and need an interim fixup steps before parsing.

### `scrape`

The main entry point to Skyscraper is the `scrape` function. It is invoked as follows:

```clojure
(scrape seed params)
```

where `seed` is an initial seq of contexts (typically generated by a separate function) or a symbol or keyword naming such a function, and `params` are optional keyword parameters. The parameters currently supported are:

 - `:html-cache` (default `true`) – A CacheBackend implementation to use as the HTML cache. Can also be specified as a boolean value: `true` constructs a filesystem-backed cache (`FSCache`) with the default directory, while `false` signals a null cache (effectively disabling the HTML cache).
 - `:processed-cache` (default `true`) – Likewise, but for the processed cache.
 - `:http-options` – A map of additional options to pass to [clj-http], which Skyscraper uses under the hood to download pages from the Web. These options override the defaults, which are `{:as :auto, :socket-timeout 5000, :decode-body-headers true}` (set timeout to 5 seconds and autodetect the encoding). See clj-http’s documentation for other options you can pass here.
 - `:update` (default (`true`) – Runs Skyscraper in “update mode”. In this mode, Skyscraper will re-download and re-process pages whose processors are marked as `:updatable`, even if the corresponding keys are present in the HTML or processed caches.
 - `:retries` (default 5) – How many times Skyscraper will retry to download the page in the event of an error until it gives up.
 - `:only` – A map or seq of maps used to narrow down the output. For example, if you scrape the database of countries and cities where each country has its own page, then you can specify `:only {:country "France"}` to restrict the output to French cities only. This has the same effect as filtering the output of `scrape` manually, but is faster because it allows Skyscraper to prune the scraping tree. Alternatively, you can specify a predicate that will be used to filter results.
 - `:postprocess` – If specified, this function is called on the result seq of each processor to transform it before the next processor is run. This happens after results are filtered via `:only`.
 - `:error-handler` – An error handler for processors that don’t specify their own.

 [clj-http]: https://github.com/dakrone/clj-http

The output is a lazy seq of leaf contexts. This means that each map in this seq contains keys from every context that led to it being generated. For example, given the following scenario:

 - The first processor called by Skyscraper returns `[{:a 1, :url "someurl", :processor :processor2}]`
 - The second processor (`processor2`) returns `[{:b 2, :url "nexturl", :processor :processor3}]`
 - The third and final processor returns `[{:c 3} {:c 4}]`

Then the final output will be `({:a 1, :b 2, :c 3} {:a 1, :b 2, :c 4})`.

### Other functions

There are other functions that may be more convenient to use, depending on the application. These are:

 - `do-scrape`: Exactly like `scrape`, but takes a seed and an explicit map of options, instead of keyword arguments. `scrape` is in fact a very thin layer of syntactic sugar on top of `do-scrape`.
 - `scrape-csv`: Invoked as `(scrape-csv seed output-filename params)`. Saves the results of scraping to a CSV file named by `output-filename`. The first line of the file will contain column names (corresponding to leaf context keys) in an unspecified order, while the remaining lines will contain the corresponding data. Relies on the processed cache being enabled, as it invokes the scraping machinery twice (once to obtain a list of keys and once to generate the actual data), unless `:all-keys false` is specified, in which case only the keys of first scraped map will be present in the CSV file.
 - `get-cache-keys`: Invoked like `do-scrape`; runs scraping, but instead of normal output, returns a vector containing the generated cache keys and processors that produced them. Not lazy.

## Namespace: `skyscraper.helpers`

## Namespace: `skyscraper.cache`

## Namespace: `skyscraper.traverse`

## Namespace: `skyscraper.data`

## Namespace: `skyscraper.sqlite`
